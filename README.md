<div align="center">
  <img src="https://github.com/user-attachments/assets/7d1db448-69e0-416d-9ccb-d8d2c4324a3f" alt="kuva_space_logo" width="50%"/>
</div>

# Kuva Data Processing

This project is aimed for externals to be able to read and process data products
generated by the Kuva Space Hyperfield satellites.

**Table of Contents**
- [Project contents](#project-contents)
- [Installation from Pypi](#installation-from-pypi)
- [Installation from source](#installation-from-source)
  - [Installing a virtual environment](#installing-a-virtual-environment)
  - [Installing the projects](#installing-the-projects)
- [Code](#code)
  - [Kuva reader - Minimal example](#kuva-reader---minimal-example)
  - [Kuva reader - Inspect product](#kuva-reader---inspect-product)
- [Contributing](#contributing)
- [Contact information](#contact-information)
- [License](#license)

## Project contents

The data reader consists of two sub-projects:

1. `kuva-metadata`, which contains metadata definitions of all the different parts and 
devices of the Kuva products
2. `kuva-reader`, which can be used to read data products produced by Hyperfield in a 
Pythonic way. Given a geotiff and its metadata sidecar file, a data product can be 
loaded and processed.
3. `kuva-geometry`, which contains some helper functionalities and class definitions for 
calculating geometric properties, such as camera ray intersections on the Earth.


# Installation from Pypi

To be added

# Installation from source

## Installing a virtual environment

To make installation smooth and sure to work, we recommend installing a virtual 
environment with a specific Python version, along with the Poetry program for handling Python package installing.

One example of a virtual environment manager is pyenv, which can be installed with

```bash
# Update local packages
sudo apt update -y
# Install Pyenv
curl https://pyenv.run | bash

# Then configure your bash script to recognize pyenv
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init -)"' >> ~/.bashrc
echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
source ~/.bashrc
```

We recommend using Python version 3.10.12 for `kuva-datareader`

```bash
# Install the Python version
pyenv install 3.10.12
# Create a virtual environment with the given Python version
pyenv virtualenv 3.10.12 kuva-env
# Activate the virtual environment
pyenv activate kuva-env
```

Python dependencies are managed by Poetry, install it to your virtual environment with

```bash
pip install poetry
```


## Installing the projects

As explained above, the installation is best done within a virtual environment using 
Poetry with the following commands (tested on **Python 3.10.14**). For example, to install 
the `kuva-reader` library, which also does have the `kuva-metadata` and `kuva-geometry` 
libraries as dependency, use the following commands:


```bash
cd kuva-reader
poetry install
```


# Code
### Kuva reader - Minimal example

This is a minimal example that allows you to read and print the image shape of a L1 product. \
The result product is in this case an L1C product (as seen from the folder name). 
The loaded product is stored in a `rioxarray` object, which contains extensive GIS functionalities [(examples for usage)](https://corteva.github.io/rioxarray/stable/examples/examples.html). 

```python
from pathlib import Path

from kuva_reader import Level1ABProduct

DATA_ROOT = Path("data")
product_path = DATA_ROOT / "hyperfield1a_L1B_20250105T092548/"

product = Level1ABProduct(product_path)
print(product.image.shape)
```

### Kuva reader - Inspect product

Inside the `kuva-reader` folder there is a script called `inspect_product.py` that you can use to play with the `Level1Product` Python implementation.

> **NOTE:** Currently, the `inspect_product.py` script prints only the shape of the image, however it can be easily extended with every kind of inspection needed.\
> For instance, you can try to print the product metadata with:\
    ```python 
    print(f"Product image metadata: {product.metadata}")
    ```

```shell
# From repo root folder access to kuva-reader folder
cd kuva-reader
``` 

The you can run with the `inspect_product.py` script in the following way:
```shell
python3 inspect_product.py your_datafolder/hyperfield1a_L1X_YYY/
``` 
Where the `X` in `L1X` refers to different products (Level 1 `B` and Level 1 `C`), and therefore it can change.


### *For Kuva developers: publishing the newest version in PyPi*

To publish to PyPi, follow the steps:

1. Configure PyPi credentials for Poetry
2. Review/verify code integrity and run tests
3. Update package version in the `pyproject.toml` file
4. `cd` into the package to update
5. `poetry build`
6. One last check of the generated files and current directory
7. `poetry publish`


# Contributing

Please follow the guidelines in [CONTRIBUTING.md](CONTRIBUTING.md).

Also, please follow our [Code of Conduct](CODE_OF_CONDUCT.md) while discussing in the 
issues and pull requests.

# Contact information

For questions or support, please open an issue. If you have been given a support contact, 
feel free to send them an email explaining your issue.

# License

The `kuva-data-processing` repository software is under the [MIT license](LICENSE.md).

# Status of unit tests

[![Unit tests for kuva-geometry](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-geometry.yml/badge.svg?branch=main)](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-geometry.yml?branch=main)
[![Unit tests for kuva-metadata](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-metadata.yml/badge.svg?branch=main)](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-metadata.yml?branch=main)
[![Unit tests for kuva-reader](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-reader.yml/badge.svg?branch=main)](https://github.com/KuvaSpace/kuva-data-processing/actions/workflows/test-kuva-reader.yml?branch=main)
